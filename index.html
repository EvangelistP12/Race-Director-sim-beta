<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Race Director Sim ‚Äî v4.1.3 (official mobile refit + button Fallback)</title>
<style>
:root{--panel:#101a2d;--panel2:#14233f;--stroke:#283e67;--text:#eaf0ff;--muted:#b8c4da;--accent:#e10600}
*{box-sizing:border-box} html,body{margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-tap-highlight-color:transparent}
body{touch-action:manipulation;background:#0b142a}
.wrap{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:12px}
#game,#ui{background:rgba(16,26,45,.95);backdrop-filter:saturate(1.2) blur(2px);border:1px solid var(--stroke);border-radius:14px}
#game{padding:10px}
#ui{padding:12px;display:flex;flex-direction:column;gap:10px;position:sticky;top:10px;height:fit-content}
.title{font-weight:800;letter-spacing:.3px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:#1a2746}
.flag{width:16px;height:16px;border-radius:3px;border:1px solid #0008;display:inline-block}
.flag.green{background:#00e676}.flag.yellow{background:#ffeb3b}.flag.red{background:#ff1744}
.flag.sc{background:linear-gradient(45deg,#ffd600 50%,#000 50%);border:1px solid #000}
button,select{background:#1a2746;color:var(--text);border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;cursor:pointer}
button:hover{filter:brightness(1.12)}button:active{transform:scale(.98)}
.divider{height:1px;background:var(--stroke);margin:6px 0}
.notice{border:1px dashed #5172b8;border-radius:10px;padding:10px;background:#0f1730;color:#c5d4ff}
.mini{font-size:12px;color:var(--muted)}
canvas{display:block;border-radius:12px;background:transparent;width:100%;height:auto;max-width:100%}
.hud{display:flex;justify-content:space-between;gap:8px;margin-top:6px;flex-wrap:wrap}

/* MENU */
#menu{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;padding:16px;background:radial-gradient(80% 80% at 50% 40%, #1a2744 0%, #0b142a 70%)}
#menu.hidden{display:none !important}
.menu-card{width:min(980px,96vw);background:#0f1730;border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 10px 40px #0008}
.banner{background:linear-gradient(120deg,#1d2c52,#14264a 55%, #1a2238);border:1px solid #2a3f70;border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:space-between}
.btnPrimary{background:#e10600;border:0;color:#fff;border-radius:10px;padding:12px 16px;font-weight:800}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{background:var(--panel2);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}

/* MOBILE: pannelli in ordine comodo */
@media (max-width:980px){
  .wrap{grid-template-columns:1fr}
  #game{order:-1}
  #ui{order:0;display:flex;flex-direction:column}
  canvas{aspect-ratio:10/13;min-height:70vh}
  #flagsBlock{order:1}
  #penBlock{order:2}
  #raceBlock{order:3}
  #leaderBlock{order:4}
}
</style>
</head>
<body>
<!-- MENU -->
<div id="menu" aria-modal="true">
  <div class="menu-card">
    <div class="banner">
      <div>
        <div class="title" style="font-size:28px;">Race Director Sim</div>
        <div class="mini">v4.1.3 ‚Äî Mobile refit (circuito grande, grafica migliorata)</div>
      </div>
      <div class="row">
        <!-- FALLBACK: onclick globale -->
        <button id="btnTutorial" class="pill" type="button" onclick="__tutorial()">üìò Tutorial</button>
        <button id="btnPlayNow" class="btnPrimary" type="button" onclick="__startGame()">Gioca ora</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="grid2">
        <div><div class="label">Giri</div>
          <select id="optLaps"><option>5</option><option>7</option><option selected>10</option><option>15</option><option>20</option><option>25</option></select></div>
        <div><div class="label">Difficolt√†</div>
          <select id="optDiff"><option value="easy">Facile</option><option value="med" selected>Media</option><option value="hard">Difficile</option></select></div>
        <div><div class="label">Pista</div>
          <select id="optTrack"><option value="imola">Imola</option><option value="monza">Monza</option><option value="monaco">Monaco</option><option value="abudhabi">Abu Dhabi</option></select></div>
        <div><div class="label">Meteo</div>
          <select id="optWeather"><option value="auto" selected>Automatico</option><option value="sunny">Sole</option><option value="cloudy">Nuvoloso</option><option value="rainLight">Pioggia leggera</option><option value="rainHeavy">Pioggia forte</option></select></div>
      </div>
      <div class="row" style="margin-top:10px">
        <!-- FALLBACK: onclick globale -->
        <button id="btnStart" class="btnPrimary" type="button" onclick="__startGame()">üéÆ Gioca</button>
        <span class="mini">UI mobile: circuito pi√π grande, tribune animate.</span>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="game">
    <div class="row" style="justify-content:space-between;margin-bottom:8px;">
      <div class="title">Race Director Sim ‚Äî v4.1.3</div>
      <div class="row"><div class="pill"><span class="flag green"></span><span id="flagLabel">GREEN</span></div></div>
    </div>
    <canvas id="track" width="1280" height="900"></canvas>
    <div class="hud">
      <div>Giro: <span id="lap">1</span>/<span id="maxLap">10</span></div>
      <div>Safety Car: <span id="scStatus">Off</span></div>
      <div>Meteo: <span id="weatherTxt">Auto</span></div>
      <div>Pit: <span id="pitInfo">‚Äî</span></div>
      <div>Punteggio: <span id="score">0</span></div>
    </div>
    <div id="incidentBox" class="notice" style="display:none;margin-top:8px;"></div>
  </div>

  <!-- UI laterale -->
  <div id="ui">
    <!-- Bandiere -->
    <section id="flagsBlock">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title">Controlli bandiere</div>
        <button id="btnJumpTrack">üé• Vai al circuito</button>
      </div>
      <div class="row">
        <button id="btnGreen">üü© Verde</button>
        <button id="btnYellow">üü® Gialla</button>
        <button id="btnSC">üöó Safety Car</button>
        <button id="btnRed">üü• Rossa</button>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Penalit√† -->
    <section id="penBlock">
      <div class="title">Penalit√†</div>
      <div class="row"><select id="carSelect"></select></div>
      <div class="row">
        <button data-pen="+5s">+5s</button>
        <button data-pen="+10s">+10s</button>
        <button data-pen="DT">Drive-through</button>
        <button data-pen="SG10">Stop&Go 10s</button>
        <button data-pen="BLACK">Bandiera Nera</button>
        <button id="btnClearPen">Annulla ultima</button>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Gara -->
    <section id="raceBlock">
      <div class="title">Gara</div>
      <div class="row">
        <button id="btnPause">‚è∏Ô∏è Pausa</button>
        <button id="btnResume">‚ñ∂Ô∏è Riprendi</button>
        <button id="btnRestart">üîÅ Nuova Gara</button>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Classifica -->
    <section id="leaderBlock">
      <div class="title">Classifica in tempo reale</div>
      <div class="card" style="max-height:300px;overflow:auto;margin-bottom:8px">
        <table style="width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums">
          <thead class="mini" style="position:sticky;top:0;background:#13203b">
            <tr><th style="text-align:left;padding:6px">#</th>
                <th style="text-align:left;padding:6px">Team</th>
                <th style="text-align:right;padding:6px">Pilota</th>
                <th style="text-align:right;padding:6px">Giro</th>
                <th style="text-align:right;padding:6px">Gap</th>
                <th style="text-align:right;padding:6px">Pen</th></tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>

    <div class="card mini">Refit mobile: circuito grande, F1 ridisegnate, sfondo tribune veloce, meteo realistico. UI mobile: bandiere & penalit√† sopra la classifica.</div>
    <div id="diag" class="mini" style="display:none;background:#2a1b1b;border:1px solid #8b3a3a;border-radius:8px;padding:8px;white-space:pre-wrap"></div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const canvas=$('track'), ctx=canvas.getContext('2d');
  let W=canvas.width, H=canvas.height, DPR=1;

  const HUD={lap:$('lap'),max:$('maxLap'),sc:$('scStatus'),score:$('score'),flagTxt:$('flagLabel'),weather:$('weatherTxt'),inc:$('incidentBox'),pit:$('pitInfo')};
  const menu=$('menu'), optLaps=$('optLaps'),optDiff=$('optDiff'),optTrack=$('optTrack'),optWeather=$('optWeather');

  window.onerror=(m,src,ln,col)=>{ const d=$('diag'); d.style.display='block'; d.textContent+=(d.textContent?'\n':'')+`Errore: ${m} @ ${ln}:${col}`; };

  /* ===== Resize & Scroll ===== */
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const cssW = Math.max(320, rect.width || (canvas.parentElement?.clientWidth||800));
    const cssH = Math.round(cssW * (innerWidth<980?1.3:0.7)); // pi√π alto su mobile
    DPR = Math.min(2, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);
    W = canvas.width; H = canvas.height;
    buildPathAndPit(trackKey); seedBackground();
  }
  function scrollToTrack(){ setTimeout(()=>{ $('game').scrollIntoView({behavior:'smooth',block:'start'}); }, 80); }
  window.addEventListener('resize', ()=>{ resizeCanvas(); drawOnce(); }, {passive:true});
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ resizeCanvas(); drawOnce(); }, 300); }, {passive:true});
  $('btnJumpTrack')?.addEventListener('click', scrollToTrack);

  /* ===== Tracciati ===== */
  const TRACKS={
    imola:[[-0.26,-0.92],[0.38,-0.92],[0.68,-0.80],[0.85,-0.55],[0.76,-0.20],[0.45,-0.02],[0.10,0.05],[-0.12,0.30],[-0.22,0.55],[-0.38,0.82],[-0.68,0.92],[-0.88,0.72],[-0.84,0.38],[-0.64,0.12],[-0.36,-0.04],[-0.10,-0.22],[0.08,-0.48],[0.02,-0.75],[-0.12,-0.90],[-0.26,-0.92]],
    monza:[[0.88,-0.90],[0.20,-0.90],[-0.42,-0.82],[-0.78,-0.56],[-0.86,-0.24],[-0.62,0.02],[-0.20,0.02],[0.40,-0.06],[0.78,0.10],[0.86,0.40],[0.60,0.72],[0.10,0.88],[-0.42,0.86],[-0.86,0.66],[-0.94,0.36],[-0.70,0.06],[-0.24,-0.10],[0.40,-0.18],[0.92,-0.30],[0.96,-0.60],[0.88,-0.90]],
    monaco:[[-0.80,-0.35],[-0.60,-0.46],[-0.30,-0.52],[0.00,-0.50],[0.20,-0.40],[0.28,-0.22],[0.18,-0.02],[-0.02,0.10],[-0.22,0.16],[-0.46,0.18],[-0.60,0.30],[-0.58,0.50],[-0.40,0.66],[-0.12,0.72],[0.12,0.64],[0.34,0.46],[0.52,0.24],[0.64,0.02],[0.70,-0.20],[0.62,-0.36],[0.40,-0.44],[0.10,-0.46],[-0.26,-0.40],[-0.56,-0.36],[-0.80,-0.35]],
    abudhabi:[[-0.80,-0.60],[-0.35,-0.70],[0.10,-0.72],[0.48,-0.60],[0.72,-0.34],[0.80,-0.02],[0.70,0.24],[0.46,0.40],[0.10,0.46],[-0.28,0.42],[-0.56,0.28],[-0.74,0.08],[-0.68,-0.10],[-0.52,-0.30],[-0.26,-0.46],[0.08,-0.52],[0.42,-0.42],[0.64,-0.18],[0.60,0.04],[0.44,0.20],[0.18,0.28],[-0.14,0.26],[-0.46,0.16],[-0.66,-0.04],[-0.76,-0.30],[-0.80,-0.60]]
  };
  function buildPath(poly,padding=(innerWidth<980?50:70)){
    const xs=poly.map(p=>p[0]), ys=poly.map(p=>p[1]);
    const s=Math.min((W-2*padding)/(Math.max(...xs)-Math.min(...xs)), (H-2*padding)/(Math.max(...ys)-Math.min(...ys)));
    const ox=padding-Math.min(...xs)*s, oy=padding-Math.min(...ys)*s;
    const pts=poly.map(([x,y])=>({x:x*s+ox,y:y*s+oy}));
    const segs=[],cum=[0]; let tot=0;
    for(let i=1;i<pts.length;i++){const a=pts[i-1],b=pts[i];const L=Math.hypot(b.x-a.x,b.y-a.y);segs.push({a,b,L});tot+=L;cum.push(tot)}
    return {pts,segs,cum,total:tot};
  }
  function posOnPath(path,dist){
    const d=((dist%path.total)+path.total)%path.total;let i=1;while(i<path.cum.length&&path.cum[i]<d)i++;
    const s=path.segs[i-1],t=(d-path.cum[i-1])/Math.max(1e-6,(path.cum[i]-path.cum[i-1]));
    const x=s.a.x+(s.b.x-s.a.x)*t, y=s.a.y+(s.b.y-s.a.y)*t; const ang=Math.atan2(s.b.y-s.a.y,s.b.x-s.a.x);
    return {x,y,ang,nx:-Math.sin(ang),ny:Math.cos(ang)};
  }

  /* ===== Sfondo + pubblico ===== */
  let bokeh=[],stands=[]; 
  function seedBackground(){
    bokeh = Array.from({length:22},()=>({x:Math.random()*W,y:Math.random()*H,r:70+Math.random()*140,dx:(Math.random()<.5?-1:1)*(0.08+Math.random()*0.18),dy:(Math.random()<.5?-1:1)*(0.04+Math.random()*0.12),hue:210+Math.random()*25}));
    const rows = innerWidth<980 ? 10 : 14;
    stands = Array.from({length:rows},(_,i)=>({y:(i+1)*H/(rows+1),x:Math.random()*W,w:200+Math.random()*320,h:12+Math.random()*20,v:3+Math.random()*6,alpha:.14+.08*Math.random()}));
  }
  function drawBackground(){
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,"#8eb0db"); g.addColorStop(0.55,"#5f83b6"); g.addColorStop(1,"#2b3c5f");
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=.18; bokeh.forEach(b=>{const rad=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r); rad.addColorStop(0,`hsla(${b.hue},45%,60%,1)`); rad.addColorStop(1,"rgba(0,0,0,0)"); ctx.fillStyle=rad; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); b.x+=b.dx; b.y+=b.dy; if(b.x<-b.r) b.x=W+b.r; if(b.x>W+b.r) b.x=-b.r; if(b.y<-b.r) b.y=H+b.r; if(b.y>H+b.r) b.y=-b.r; }); ctx.globalAlpha=1;
    const G=Math.floor(H*0.34); ctx.fillStyle="#0e3c2d"; ctx.fillRect(0,H-G,W,G);
    stands.forEach(s=>{ ctx.globalAlpha=s.alpha; ctx.fillStyle="#1b243a"; ctx.fillRect(s.x,s.y,s.w,s.h); ctx.fillStyle="#9fb3e6"; ctx.fillRect(s.x+12,s.y-14,120,10); for(let i=0;i<110;i++){const px=s.x+6+Math.random()*(s.w-12); const py=s.y+4+Math.random()*(s.h-8); ctx.fillStyle = Math.random()<0.5 ? "#e2b15a" : (Math.random()<0.5 ? "#9fd1ff" : "#ff7a7a"); ctx.fillRect(px,py,1.2,1.2);} s.x-=s.v; if(s.x+s.w<-80){ s.x=W+Math.random()*240; s.w=200+Math.random()*320; s.h=12+Math.random()*20; s.v=3+Math.random()*6; } }); ctx.globalAlpha=1;
  }

  /* ===== Meteo ===== */
  let weather="sunny", rain=[];
  function setWeather(mode){ if(mode==="auto"){const r=Math.random(); weather = r<0.6?"sunny":r<0.8?"cloudy":(Math.random()<0.6?"rainLight":"rainHeavy"); } else weather=mode; $('weatherTxt').textContent=weather==="sunny"?"Sole":weather==="cloudy"?"Nuvoloso":weather==="rainLight"?"Pioggia leggera":"Pioggia forte"; }
  function drawWeather(){
    if(weather==="cloudy"){ ctx.globalAlpha=.16; ctx.fillStyle="#a8b9d6"; const cx=Math.max(6,Math.floor(W/220)); for(let i=0;i<cx;i++){ctx.beginPath();ctx.ellipse((i*220+80)%W,90+(i%3)*28,180,46,0,0,Math.PI*2);ctx.fill()} ctx.globalAlpha=1; }
    else if(weather==="rainLight"||weather==="rainHeavy"){ const N=Math.floor((weather==="rainHeavy"?320:200)*(W/1280)); if(rain.length<N) for(let i=rain.length;i<N;i++) rain.push({x:Math.random()*W,y:Math.random()*H,v:2+Math.random()*5}); ctx.strokeStyle="#9ec5ff"; ctx.globalAlpha=weather==="rainHeavy"?0.85:0.65; ctx.lineWidth=1; rain.forEach(d=>{ctx.beginPath();ctx.moveTo(d.x,d.y);ctx.lineTo(d.x+2*DPR,d.y+8*DPR);ctx.stroke();d.x+=1.6*DPR;d.y+=d.v*DPR;if(d.y>H)d.y=-10;if(d.x>W)d.x=0}); ctx.globalAlpha=1; }
  }
  const grip=()=>weather==="sunny"?1:weather==="cloudy"?0.96:weather==="rainLight"?0.88:0.78;

  /* ===== Pubblico bordo pista ===== */
  let fans=[];
  function makeFans(path,gap=34,bands=5){
    const res=[],col=["#ff5252","#ffd600","#00e676","#40c4ff","#e040fb","#ffab40","#f06292"];
    for(const side of[-1,1])for(let d=0;d<path.total;d+=gap){const p=posOnPath(path,d);for(let b=0;b<bands;b++){const off=38+b*16;res.push({x:p.x+p.nx*off*side,y:p.y+p.ny*off*side,ph:Math.random()*6.28,amp:1.7+Math.random()*2.6,c:col[(b+(side>0?1:0))%col.length]})}}
    return res;
  }
  function drawFans(t){for(const f of fans){const bob=Math.sin(t*0.003+f.ph)*f.amp;ctx.fillStyle=f.c;ctx.beginPath();ctx.arc(f.x,f.y+bob,2.4,0,Math.PI*2);ctx.fill();}}

  /* ===== Pista + pit ===== */
  let path=null,pit=null,trackKey="imola";
  function buildPit(p){
    const st=posOnPath(p,0),off=62,len=320,w=20;
    const px=st.x+st.nx*off,py=st.y+st.ny*off,vx=Math.cos(st.ang),vy=Math.sin(st.ang),nx=-vy,ny=vx;
    const p1={x:px-vx*len*0.5,y:py-vy*len*0.5},p2={x:px+vx*len*0.5,y:py+vy*len*0.5};
    const rect=[{x:p1.x+nx*w,y:p1.y+ny*w},{x:p2.x+nx*w,y:p2.y+ny*w},{x:p2.x-nx*w,y:p2.y-ny*w},{x:p1.x-nx*w,y:p1.y-ny*w}];
    const stalls=[];for(let i=0;i<6;i++){const t=(i+0.5)/6;stalls.push({x:p1.x+(p2.x-p1.x)*t,y:p1.y+(p2.y-p1.y)*t})}
    return {entry:42,exit:176,rect,ang:st.ang,stalls};
  }
  function drawPit(){ if(!pit) return; ctx.fillStyle="#2a3f70";ctx.beginPath();ctx.moveTo(pit.rect[0].x,pit.rect[0].y);for(let i=1;i<pit.rect.length;i++)ctx.lineTo(pit.rect[i].x,pit.rect[i].y);ctx.closePath();ctx.fill(); ctx.fillStyle="#cfe2ff";ctx.font=Math.max(12,Math.floor(W/120))+"px monospace";ctx.fillText("PIT",pit.rect[0].x,pit.rect[0].y-8); }
  function buildPathAndPit(key){ trackKey=key; path=buildPath(TRACKS[key]); pit=buildPit(path); fans=makeFans(path); }
  function drawTrack(){
    if(trackKey==="monaco"){const G=Math.floor(H*0.34);ctx.fillStyle="#0c2a3e";ctx.fillRect(0,H-G-120,W,120);for(let i=0;i<6;i++){ctx.fillStyle="#c7e9f7";ctx.fillRect(60+i*220,H-G-90,120,34)}}
    if(trackKey==="abudhabi"){ctx.fillStyle="#0f2146";ctx.fillRect(0,0,W,90);for(let i=0;i<8;i++){ctx.fillStyle="#1b2f63";ctx.fillRect(i*160,18,90,44)}}
    drawFans(performance.now());
    ctx.lineCap="round"; ctx.lineJoin="round";
    ctx.strokeStyle="#4c648f"; ctx.lineWidth=46; ctx.beginPath(); ctx.moveTo(path.pts[0].x,path.pts[0].y); for(let i=1;i<path.pts.length;i++)ctx.lineTo(path.pts[i].x,path.pts[i].y); ctx.stroke();
    ctx.strokeStyle="#5b74a6"; ctx.lineWidth=40; ctx.beginPath(); ctx.moveTo(path.pts[0].x,path.pts[0].y); for(let i=1;i<path.pts.length;i++)ctx.lineTo(path.pts[i].x,path.pts[i].y); ctx.stroke();
    const step = 26;
    for(let d=0; d<path.total; d+=step){
      const p=posOnPath(path,d); const w=22;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.ang);
      ctx.fillStyle = (Math.floor(d/step)%2)? "#e6e9f2":"#e10600";
      ctx.fillRect(-w/2,-22, w, 8);
      ctx.fillRect(-w/2, 14, w, 8);
      ctx.restore();
    }
    ctx.strokeStyle="#cfd8ef"; ctx.lineWidth=3; ctx.setLineDash([14,14]); ctx.beginPath(); ctx.moveTo(path.pts[0].x,path.pts[0].y); for(let i=1;i<path.pts.length;i++)ctx.lineTo(path.pts[i].x,path.pts[i].y); ctx.stroke(); ctx.setLineDash([]);
  }

  /* ===== Auto ===== */
  const TEAMS=["Aquila GP","Vortex","Nebula","Artemis","Orion","Tempest","Falconet","Helios","Quartz","Zenith","Argon","Volta"];
  const COLORS=["#e10600","#00d2be","#0600ef","#ff9800","#2b2d42","#00c853","#8e24aa","#ffd600","#ff1744","#40c4ff","#64ffda","#b388ff"];
  function drawF1(x,y,ang,color,num){
    ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
    const L=58, Wc=18;
    ctx.globalAlpha=.28; ctx.fillStyle="#000"; ctx.beginPath(); ctx.ellipse(2,6,L*.60,Wc*1.25,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    ctx.fillStyle="#121622"; ctx.fillRect(-L/2+8, -Wc*0.55, L-16, Wc*1.10);
    ctx.fillStyle=color; ctx.beginPath();
    ctx.moveTo(-L/2+12,-Wc*0.95); ctx.quadraticCurveTo(-4,-Wc*1.05, L/2-10,-Wc*0.55);
    ctx.lineTo(L/2-10, Wc*0.55); ctx.quadraticCurveTo(-4, Wc*1.05, -L/2+12, Wc*0.95);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle="#0f141c"; ctx.fillRect(-2,-Wc*0.55,4,Wc*1.10);
    ctx.fillStyle="#0b0f17"; ctx.fillRect(-1.4,-Wc*0.82,2.8,Wc*1.64);
    ctx.fillStyle="#e6e9f2"; ctx.fillRect(-L/2-16,-Wc*1.0,14,Wc*2.0);
    ctx.fillStyle="#d3dbec"; ctx.fillRect(L/2-6,-Wc*0.9,12,Wc*1.8);
    ctx.fillStyle="#c5cedf"; ctx.fillRect(L/2-2,-Wc*0.8,6,Wc*1.6);
    ctx.fillStyle="#0b0b0e"; [[-L/4,-Wc/1.05],[-L/4,Wc/1.05],[L/4,-Wc/1.05],[L/4,Wc/1.05]].forEach(p=>{ctx.beginPath();ctx.arc(p[0],p[1],6.2,0,Math.PI*2);ctx.fill()});
    ctx.fillStyle="#fff"; ctx.fillRect(-L/2+4,-8,18,16);
    ctx.fillStyle="#111"; ctx.font="bold 11px monospace"; const s=String(num); ctx.fillText(s,-L/2+(s.length===1?10:7),3);
    ctx.fillStyle="#fff"; ctx.fillRect(-7,-7,14,14); ctx.fillStyle="#111"; ctx.fillText(s,-5,3);
    ctx.restore();
  }
  function drawSafetyCar(x,y,ang,t){
    ctx.save();ctx.translate(x,y);ctx.rotate(ang);
    ctx.fillStyle="#ffd54f";ctx.fillRect(-26,-11,52,22);
    ctx.fillStyle="#263238";ctx.fillRect(-16,-9,24,18);
    ctx.fillStyle="#ffb300";ctx.fillRect(-30,-9,6,18);ctx.fillRect(24,-9,6,18);
    const blink=(Math.floor(t/300)%2)===0; ctx.fillStyle=blink?"#00e5ff":"#ff1744"; ctx.fillRect(-9,-16,18,5);
    ctx.restore();
  }

  /* ===== Stato gara ===== */
  const N=12;let cars=[];
  let running=false,raceOver=false,flag="GREEN",safetyCar=false,score=0;
  let nextIncident=0,incident=null,__incId=0;
  let nextInfractionTimer=0, infraction=null;
  function scheduleIncident(){ nextIncident = performance.now() + (5000 + Math.random()*15000); }
  function scheduleInfraction(){ nextInfractionTimer = performance.now() + (12000 + Math.random()*13000); }

  function newGrid(){
    cars=[];const order=[...TEAMS].sort(()=>Math.random()-.5), f=diffFactors();
    for(let i=0;i<N;i++){
      const team=order[i%order.length], color=COLORS[i%COLORS.length];
      const base=(100+Math.random()*28)*f.spd*(0.96+Math.random()*f.var);
      cars.push({id:i,team,color,number:2+i,dist=i*70,baseSpeed:base,speed:base,lap:1,finished:false,totalTime:0,penalties:[],dsq:false,mode:"race",pitTimer:0,nextPitLap:0});
    }
    const sel=$('carSelect'); sel.innerHTML=""; cars.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`#${c.number} ${c.team}`;sel.appendChild(o)});
  }
  function diffFactors(){const d=optDiff.value;return d==="easy"?{spd:.95,var:.06}:{spd:d==="hard"?1.07:1.0,var:d==="hard"?0.12:0.09}}
  let maxLap=10;
  function applyLapOptions(){maxLap=parseInt(optLaps.value,10);HUD.max.textContent=maxLap;const cad=maxLap<=10?5:7;for(const c of cars)c.nextPitLap=1+cad+(Math.random()<.5?0:1)}
  const totalMeters=c=>(c.lap-1)*path.total + c.dist;
  const formatGap=g=> g<=0 ? "‚Äî" : (Math.round(g)>path.total*0.7?`+${Math.max(1,Math.floor(g/path.total))} lap`:`+${Math.round(g)} m`);
  function updateLeaderboard(){
    const tb=$('tblBody'); const active=cars.slice().filter(c=>!c.dsq);
    active.sort((a,b)=> a.lap!==b.lap ? b.lap-a.lap : (totalMeters(b)-totalMeters(a)));
    const lead=active.length? totalMeters(active[0]) : 0;
    tb.innerHTML = active.map((c,i)=>`<tr style="border-top:1px solid #24365b">
      <td style="padding:6px">${i+1}</td>
      <td style="padding:6px">${c.team}</td>
      <td style="padding:6px;text-align:right">#${c.number}</td>
      <td style="padding:6px;text-align:right">${c.lap}/${maxLap}</td>
      <td style="padding:6px;text-align:right">${formatGap(lead-totalMeters(c))}</td>
      <td style="padding:6px;text-align:right">${c.penalties.reduce((s,p)=>s+p.secs,0)||"‚Äî"}</td>
    </tr>`).join("");
  }

  /* ===== Incidenti + mess. risoluzione ===== */
  function tryIncident(){
    if(incident||performance.now()<nextIncident||flag==="SC"||flag==="RED") return;
    const types=[
      {type:"Spin", sev:"LOW", rec:"YELLOW", msg:"Testacoda, riparte"},
      {type:"Debris", sev:"MED", rec:"YELLOW", msg:"Detriti in pista"},
      {type:"Crash", sev:"HIGH", rec:"SC", msg:"Auto ferma in zona pericolosa"},
      {type:"BigCrash", sev:"EXTREME", rec:"RED", msg:"Barriere da ripristinare"}
    ];
    let bias=trackKey==="monaco"?0.55:trackKey==="abudhabi"?0.25:0.4;
    const pick=Math.random()<bias?types[Math.floor(Math.random()*3)]:types[Math.floor(Math.random()*types.length)];
    const active=cars.filter(c=>!c.finished&&!c.dsq);
    const victim=active.length? active[Math.floor(Math.random()*active.length)] : null;

    incident={...pick,carId:victim?victim.id:null};
    const carTxt=incident.carId!=null?` (#${cars[incident.carId].number} ${cars[incident.carId].team})`:"";
    HUD.inc.innerHTML=`‚ö†Ô∏è <b>INCIDENTE:</b> ${incident.type}${carTxt} ‚Äî <i>${incident.msg}</i> <span class="mini">(Consiglio: ${incident.rec})</span>`;
    HUD.inc.style.display='block';

    const myId=++__incId; const wasSC=(incident.rec==="SC"); const delay=3000+Math.random()*2000;
    setTimeout(()=>{ if(myId!==__incId) return;
      HUD.inc.innerHTML += `<br>${(safetyCar||wasSC)?"‚úÖ Safety Car rientra, metti la bandiera verde":"‚úÖ Incidente risolto, metti la bandiera verde"}`;
    }, delay);

    scheduleIncident();
  }
  function resolveIncident(byAction){
    if(!incident){HUD.inc.style.display='none';return}
    const ok=(flag==="GREEN")||(flag===incident.rec)||(incident.rec==="SC"&&safetyCar);
    score += byAction?(ok?10:-6):-4;
    incident=null;
  }

  /* ===== Infrazioni (solo avviso) ===== */
  let nextInfractionTimer=0, infraction=null;
  function scheduleInfraction(){ nextInfractionTimer = performance.now() + (12000 + Math.random()*13000); }
  function maybeInfraction(){
    if(infraction || performance.now()<nextInfractionTimer) return;
    const kinds=["Sorpasso in bandiera gialla","Taglio di curva","Collisione evitabile","Ostacolo volontario"];
    const active=cars.filter(c=>!c.finished&&!c.dsq); if(!active.length){ scheduleInfraction(); return; }
    const car=active[Math.floor(Math.random()*active.length)];
    const what=kinds[Math.floor(Math.random()*kinds.length)];
    infraction={carId:car.id,what,expires:performance.now()+10000};
    HUD.inc.style.display='block';
    HUD.inc.innerHTML=`‚ö†Ô∏è <b>INFRAZIONE:</b> ${what} del #${car.number} ${car.team} ‚Äî <i>decidi una penalit√† dal pannello (10s)</i>`;
  }
  function updateInfraction(){
    if(infraction && performance.now()>infraction.expires){
      HUD.inc.innerHTML=`‚ÑπÔ∏è <i>Infrazione archiviata senza penalit√†</i>`; infraction=null; scheduleInfraction();
    }
  }

  /* ===== Update & Draw ===== */
  function update(dtMs){
    if(!running||raceOver) return;
    const dt=dtMs/1000, m=(flag==="RED"?0:flag==="SC"?0.45:flag==="YELLOW"?0.65:1)*grip();
    const cad=maxLap<=10?5:7; let pitNow=[];
    for(const c of cars){
      if(c.finished||c.dsq) continue;
      if(c.mode==="race"){
        c.speed=c.baseSpeed*m; c.dist+=c.speed*dt;
        if(c.dist>path.total){c.dist-=path.total;c.lap++;if(c.lap>maxLap)c.finished=true;}
        if(pit && c.lap===c.nextPitLap){ if(c.dist<pit.entry+44){ c.mode="pit_entry"; c.pitTimer=0; pitNow.push("#"+c.number); c.nextPitLap+=cad+(Math.random()<.5?0:1); } }
      }else if(c.mode==="pit_entry"){ c.pitTimer+=dt*.8; if(c.pitTimer>=1){ c.mode="pit_stop"; c.pitTimer=1800+Math.random()*1400; } }
      else if(c.mode==="pit_stop"){ c.pitTimer-=dtMs; if(c.pitTimer<=0){ c.mode="pit_exit"; c.pitTimer=0; } }
      else if(c.mode==="pit_exit"){ c.pitTimer+=dt*.9; if(c.pitTimer>=1){ c.mode="race"; c.dist=pit?pit.exit+6:c.dist; } }
      c.totalTime+=dtMs;
    }
    if(pitNow.length) HUD.pit.textContent=pitNow.join(", ");
    tryIncident(); maybeInfraction(); updateInfraction();

    if(cars.every(c=>c.finished||c.dsq)){ raceOver=true; running=false; HUD.inc.style.display='block'; HUD.inc.innerHTML="üèÅ <b>FINE GARA</b> ‚Äî Usa ‚ÄúNuova Gara‚Äù per ricominciare."; }
  }
  function draw(){
    drawBackground(); drawWeather(); drawTrack(); drawPit();
    for(const c of cars){ if(c.dsq) continue; const p=posOnPath(path,c.dist); drawF1(p.x,p.y,p.ang,c.color,c.number); }
    if(safetyCar){ const p=posOnPath(path,(performance.now()/8)%path.total); drawSafetyCar(p.x,p.y,p.ang,performance.now()); }
    HUD.lap.textContent=Math.max(...cars.map(c=>c.lap));
    HUD.sc.textContent=safetyCar?"On":"Off";
    HUD.score.textContent=Math.floor(score);
    HUD.flagTxt.textContent=flag;
    HUD.flagTxt.previousElementSibling.className="flag "+(flag==="GREEN"?"green":(flag==="YELLOW"?"yellow":(flag==="RED"?"red":"sc")));
  }
  function loop(now){ const dt=now-(window.__lastT||now); window.__lastT=now; if(running) update(dt); draw(); updateLeaderboard(); requestAnimationFrame(loop); }
  function drawOnce(){ drawBackground(); drawTrack(); drawPit(); }
  requestAnimationFrame(loop);
  setTimeout(()=>{ resizeCanvas(); drawOnce(); },200);

  /* ===== Bandiere & penalit√† ===== */
  const setFlag=f=>{ if(raceOver) return; flag=f; safetyCar=(f==="SC"); if(incident) resolveIncident(true); };
  $('btnGreen').onclick=()=>setFlag("GREEN"); $('btnYellow').onclick=()=>setFlag("YELLOW"); $('btnSC').onclick=()=>setFlag("SC"); $('btnRed').onclick=()=>setFlag("RED");

  document.querySelectorAll('button[data-pen]').forEach(b=>b.onclick=()=>{
    const id=parseInt($('carSelect').value,10),car=cars.find(c=>c.id===id); if(!car||raceOver)return;
    const t=b.getAttribute('data-pen'); let secs=0;
    if(t==="BLACK"){ car.dsq=true; }
    else if(t==="DT"){ secs=0; }
    else if(t==="SG10"){ secs=10; car.penalties.push({type:t,secs}); }
    else if(t==="+5s"){ secs=5; car.penalties.push({type:t,secs}); }
    else if(t==="+10s"){ secs=10; car.penalties.push({type:t,secs}); }
    HUD.inc.style.display='block'; HUD.inc.innerHTML=`üìù Penalit√† assegnata a #${car.number}: <b>${t}${secs?(" ("+secs+"s)"):''}</b>`;
  });
  $('btnClearPen').onclick=()=>{
    const id=parseInt($('carSelect').value,10),car=cars.find(c=>c.id===id); if(!car)return;
    if(car.dsq){ car.dsq=false; HUD.inc.innerHTML='‚Ü©Ô∏è Bandiera nera annullata'; HUD.inc.style.display='block'; return; }
    const p=car.penalties.pop();
    HUD.inc.style.display='block'; HUD.inc.innerHTML= p ? `‚Ü©Ô∏è Rimossa ${p.type}${p.secs?(" ("+p.secs+"s)"):''}` : '‚Ü©Ô∏è Nessuna penalit√† da rimuovere';
  };

  /* ===== Avvio gara ===== */
  function newRaceSetup(){ buildPathAndPit(optTrack.value); setWeather(optWeather.value); newGrid(); applyLapOptions(); HUD.pit.textContent="‚Äî"; HUD.inc.style.display='none'; }
  function startRace(){ running=false; raceOver=false; flag="GREEN"; safetyCar=false; score=0; incident=null; scheduleIncident(); scheduleInfraction(); newRaceSetup(); running=true; }

  /* >>> ESPONGO startRace GLOBALMENTE (fallback) <<< */
  window.startRace = startRace;

  /* ====== Fallback globale per i bottoni (onclick) ====== */
  window.__startGame = function(){
    try { window.startRace(); } catch(e){ console.error(e); alert("Errore avvio gara: " + e.message); }
    document.getElementById('menu')?.classList.add('hidden');
    resizeCanvas(); drawOnce?.(); scrollToTrack?.();
  };
  window.__tutorial = function(){
    alert("Sei il Direttore di Gara:\n‚Ä¢ Scegli giri/pista/difficolt√† e premi Gioca.\n‚Ä¢ Bandiere: Verde/Gialla/SC/Rossa.\n‚Ä¢ Penalit√† dal pannello.\n‚Ä¢ Incidenti ogni 5‚Äì20s con messaggio 'incidente risolto'.");
  };

  /* ===== Preview iniziale ===== */
  buildPathAndPit("imola"); setWeather("sunny"); seedBackground(); resizeCanvas(); drawOnce();
})();
</script>
</body>
</html>
